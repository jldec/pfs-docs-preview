<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400italic,400,600' rel='stylesheet' type='text/css'>
  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      JavaScript Functions |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/stylesheets/all.css" rel="stylesheet" media="screen, print" />
  <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
  <link href='/images/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js"></script>
  

<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','');
</script>


<!-- <script type="text/javascript">
  if (window.location.host === 'docs.pivotal.io') {
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '']);
    _gaq.push(['_setDomainName', '']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    })();
  }
</script> -->

<script type="text/javascript">
  var blackList = ['acceptance'];

  blackList.forEach(function(blackListedEnv) {
    if (document.URL.indexOf(blackListedEnv) > -1 && blackListedEnv != "") {
      $('head').append('<meta name="hashtag" content="PivotalMoment">');
    }
  });
</script>

<!-- CrazyEgg Tracking Script -->
<!--   <script type="text/javascript">
  setTimeout(function(){var a=document.createElement("script");
  var b=document.getElementsByTagName("script")[0];
  a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0055/2990.js?"+Math.floor(new Date().getTime()/3600000);
  a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script> -->

<!-- Munchkin Marketo Script -->
<!-- <script type="text/javascript">
  (function() {
    var didInit = false;

    function initMunchkin() {
      if (didInit === false) {
        didInit = true;
        Munchkin.init('625-IUJ-009');
      }
    }

    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
      if (this.readyState == 'complete' || this.readyState == 'loaded') {
        initMunchkin();
      }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
  })();
</script> -->

</head>

<body class="pfs pfs_using-javascript-functions has-subnav">

<div class="viewport">
  <div class='wrap'>
    <script type="text/javascript">
      document.domain = "";
    </script>

      <header class="global-header header header-layout js-bar-links">
    <div class='super-nav'>
      <div class='container-modified'>
        <div class='header-links'>
          <div class="header-item" id='docs-header-item'>
            <a href='https://docs.pivotal.io'>Documentation</a>
          </div>
          <div class="header-item">
            <a href="https://network.pivotal.io">Downloads</a>
          </div>
          <div class="header-item">
            <a href="https://pivotal.io/support">Support</a>
          </div>
          <div class='header-item' id='contact-header-item'>
            <a href='https://pivotal.io/contact'>Contact Us</a>
          </div>
          <div class='header-item'>
            <a href="https://login.run.pivotal.io">Sign In</a>
          </div>
          <div class='header-item'>
            <a href="https://account.run.pivotal.io/z/uaa/sign-up">Register</a>
          </div>
        </div>
      </div>
      
    </div>
    <div class='container-modified'>
      <a href="/" class="global-header-title">
        <svg class="pivotal-logo" xmlns="http://www.w3.org/2000/svg" width="174.72" height="40.94" viewBox="0 0 174.72 40.94"><path class="a" d="M38.77,6h-6.2V0h6.2Zm0,34.24H32.56V10.41h6.22Z"/><path class="a" d="M74.67,10.41,66,36.18c-1.49,4.22-4.15,4.76-6.3,4.76-3.19,0-5.11-1.47-6.24-4.75l-7.22-21.4H43.39V10.41h7.45l7.44,24c.33,1,.53,1.63,1.43,1.63s1.13-.62,1.43-1.63l7.59-24Z"/><path class="a" d="M90,10.41c8.05,0,13.66,5.31,13.66,12.92V28c0,7.6-5.61,12.92-13.66,12.92S76.32,35.62,76.32,28V23.33c0-7.61,5.62-12.92,13.67-12.92M90,36c4.81,0,7.8-3.64,7.8-8V23.33c0-4.37-3-8-7.8-8-5.1,0-7.8,3.64-7.8,8V28c0,4.37,2.82,8,7.8,8"/><path class="a" d="M153.32,11.36A53.46,53.46,0,0,0,141.8,10c-8.17,0-13.24,5.15-13.24,13.45v3.27c0,8.3,5.07,13.53,13.24,13.53.19,0,1.64,0,2.3-.06v-5l-2.3.07c-4.45,0-7.43-3.43-7.43-8.53V23.44c0-5.09,3-8.52,7.43-8.52a43.88,43.88,0,0,1,6.09.38l.33.08V40.24h6.22V12.4c0-.53,0-.74-1.13-1"/><rect class="a" x="160.44" width="6.22" height="40.24"/><path class="a" d="M10.92,0H0V40.24H6.47V5.59h3.79c.81,0,1.49,0,2.18.06,5.61.1,8.35,2.33,8.35,6.69,0,.17,0,.29,0,.47,0,4-2.21,6.71-8.32,6.71H10.67c0,1.55,0,4.41,0,5.41.63,0,1.22.06,1.82.06,8.78,0,15-3.45,15-12.11,0-.17,0-.35,0-.52C27.44,3.38,20.69,0,10.92,0"/><path class="a" d="M114.7,4v6.43h10.13v4.82H114.7V32.61c0,2.73,1.74,2.8,4.26,2.8h5.87v4.83h-7.94c-5.87,0-8.48-2.35-8.48-7.63V4.84Z"/><path class="a" d="M169.52,37.64a2.6,2.6,0,1,1,2.6,2.6A2.61,2.61,0,0,1,169.52,37.64Zm2.6-2.25a2.23,2.23,0,1,0,2.22,2.24A2.24,2.24,0,0,0,172.12,35.39ZM171.55,39h-.31V36.19h.8c.72,0,1.06.33,1.06.86a.82.82,0,0,1-.58.8l.74,1.17h-.36l-.68-1.1-.67,0Zm.51-1.34c.46,0,.75-.24.75-.62s-.25-.6-.79-.6h-.48V37.7Z"/></svg><svg class="documentation-letters" xmlns="http://www.w3.org/2000/svg" width="358.62" height="30.84" viewBox="0 0 358.62 30.84"><path class="a" d="M3.71,37.26V7.45h9.52c9.25,0,15.06,6.75,15.06,14.92S22.48,37.26,13.23,37.26Zm21.9-14.89c0-7-4.47-12.6-12.38-12.6h-7V34.93h7C21.1,34.93,25.61,29.35,25.61,22.37Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M33.52,22.37C33.52,13.66,39.24,7,48,7s14.48,6.7,14.48,15.41S56.72,37.79,48,37.79,33.52,31.09,33.52,22.37Zm26.28,0c0-7.55-4.64-13.09-11.8-13.09S36.21,14.82,36.21,22.37s4.6,13.1,11.79,13.1S59.8,29.88,59.8,22.37Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M67.67,22.37C67.67,13.21,74.33,7,82.78,7a13.38,13.38,0,0,1,10.86,5.27L91.5,13.61a10.84,10.84,0,0,0-8.72-4.33c-7,0-12.42,5.32-12.42,13.09s5.45,13.1,12.42,13.1a10.82,10.82,0,0,0,8.72-4.34l2.19,1.34a13.51,13.51,0,0,1-10.91,5.32C74.33,37.79,67.67,31.54,67.67,22.37Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M98.79,25.82V7.45h2.59V25.77c0,6,3.17,9.7,9,9.7s9-3.67,9-9.7V7.45H122V25.82c0,7.37-3.94,12-11.62,12S98.79,33.15,98.79,25.82Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M154.75,37.26V10.66l-10.87,26.6h-1L132,10.66v26.6h-2.55V7.45h3.8l10.14,24.8,10.1-24.8h3.85V37.26Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M164.76,37.26V7.45h18.91V9.77H167.31v11h16v2.32h-16v11.8h16.36v2.33Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M211.29,37.26,192.52,11.65V37.26H190V7.45h2.59L211.25,32.7V7.45h2.54V37.26Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M228.81,37.26V9.77h-9.74V7.45h22.08V9.77h-9.74V37.26Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M264.93,37.26,262,29.93H246.2l-2.95,7.33H240.3L252.51,7.45h3.17l12.2,29.81ZM254.11,10.17,247.05,27.6h14.08Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M276.78,37.26V9.77H267V7.45h22.07V9.77h-9.74V37.26Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M294.39,37.26V7.45h2.55V37.26Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M303.24,22.37C303.24,13.66,309,7,317.72,7s14.48,6.7,14.48,15.41-5.76,15.42-14.48,15.42S303.24,31.09,303.24,22.37Zm26.28,0c0-7.55-4.65-13.09-11.8-13.09s-11.8,5.54-11.8,13.09,4.61,13.1,11.8,13.1S329.52,29.88,329.52,22.37Z" transform="translate(-3.71 -6.96)"/><path class="a" d="M359.83,37.26,341.06,11.65V37.26h-2.55V7.45h2.59L359.78,32.7V7.45h2.55V37.26Z" transform="translate(-3.71 -6.96)"/></svg>
      </a>
      <div class="header-item embedded-searchbar">
          <form method="get" action="/search">
            <input name="q" placeholder="Search Pivotal Function Service v0.1.0" class="search-box" />
              <input type="hidden" name="product_name" value="Pivotal Function Service" />
              <input type="hidden" name="product_version" value="0.1.0"/>
          </form>
      </div>
      <div class="btn-menu" data-behavior="MenuMobile"></div>
      <div class='header-links mobile-only'>
        <div class="header-item" id='docs-header-item'>
          <a href='https://docs.pivotal.io'>Documentation</a>
        </div>
        <div class="header-item">
          <a href="https://network.pivotal.io">Downloads</a>
        </div>
        <div class="header-item">
          <a href="https://pivotal.io/support">Support</a>
        </div>
        <div class='header-item' id='contact-header-item'>
          <a href='https://pivotal.io/contact'>Contact Us</a>
        </div>
        <div class='header-item'>
          <a href="https://login.run.pivotal.io">Sign In</a>
        </div>
        <div class='header-item'>
          <a href="https://account.run.pivotal.io/z/uaa/sign-up">Register</a>
        </div>

        <div class="header-item embedded-searchbar">
            <form method="get" action="/search">
              <input name="q" placeholder="Search Pivotal Function Service v0.1.0" class="search-box" />
                <input type="hidden" name="product_name" value="Pivotal Function Service" />
                <input type="hidden" name="product_version" value="0.1.0"/>
            </form>
        </div>
      </div>
    </div>
  </header>



    <div class="container">

      <!--googleoff: index-->
      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
  <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
<div class="nav-content">
<ul>
  <li><a href="/pfs/index.html">Pivotal Function Service (PFS)<br>Documentation</a></li>
  <li><a href="/pfs/release-notes.html">Release Notes</a></li>
</ul>
<div><b>PFS Concepts</b></div>
<ul>
  <li><a href="/pfs/concepts-knative.html">Knative</a></li>
  <li><a href="/pfs/concepts-functions-and-invokers.html">Functions and Invokers</a></li>
  <li><a href="/pfs/concepts-buildpacks.html">Buildpacks</a></li>
  <li><a href="/pfs/concepts-eventing.html">Eventing</a></li>
  <li><a href="/pfs/concepts-registries.html">Registries</a></li>
</ul>
<div><b>Installing PFS</b></div>
<ul>
  <li><a href="/pfs/install-download.html">Download PFS from Pivotal Network</a></li>
  <li><a href="/pfs/install-relocate-images.html">Relocate Container Images</a></li>
  <li><a href="/pfs/install-on-pks-gcp.html">Install on PKS on GCP</a></li>
  <li><a href="/pfs/install-on-pks-vsphere.html">Install on PKS on vSphere</a></li>
  <li><a href="/pfs/install-on-gke.html">Install on GKE</a></li>
  <li><a href="/pfs/install-on-minikube.html">Install on Minikube</a></li>
  <li><a href="/pfs/install-on-docker.html">Install on Docker Desktop</a></li>
  <li><a href="/pfs/install-uninstall.html">Uninstalling PFS</a></li>
</ul>
<div><b>Using PFS</b></div>
<ul>
  <li><a href="/pfs/using-pfs-cli.html">The pfs CLI</a></li>
  <li><a href="/pfs/using-java-functions.html">Java Functions</a></li>
  <li><a href="/pfs/using-javascript-functions.html">JavaScript Functions</a></li>
  <li><a href="/pfs/using-command-functions.html">Command Functions</a></li>
  <li><a href="/pfs/using-eventing-channels.html">Eventing Channels</a></li>
  <li><a href="/pfs/troubleshooting.html">Troubleshooting PFS</a></li>
</ul>
<div><b>Reference</b></div>
<ul>
  <li><a href="/pfs/ref-google-cloud.html">Google Cloud</a></li>
</ul>
</div><!--end of nav-content-->
</div><!--end of sub-nav-->

      <!--googleon: index-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <div class="local-header title-container">
    <div class="local-header version-info">
      LATEST VERSION: v0.1.0 - <a href="https://docs.pivotal.io/pfs/release-notes.html">RELEASE NOTES</a>
    </div>
    <div class="local-header local-title clearfix">
      <img src="/images/pfs.png">
      <span class="local-header-title">Pivotal Function Service
      </span>
      <span onClick="return true" class="local-header local-version header-dropdown">
        <a class="local-header header-dropdown-link">v0.1.0</a>
        <span class="local-header header-dropdown-content">
          <ul>
                <li>
                    <a href="https://docs.pivotal.io/pfs/using-javascript-functions.html">v0.1.0</a>
                </li>
          </ul>
        </span>
      </span>

      <!-- search was here -->
    </div>
    <div class="local-header local-header-links">
        <a href="https://docs.pivotal.io/archives/pfs-0.1.0.pdf">PDF</a>
    </div>
  </div>

          <h1 class="title-container" >
    JavaScript Functions
  </h1>

          <div id="js-quick-links" >
            <div class="quick-links"><ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#cli-java">Using the pfs CLI to Create a JavaScript Function</a></li>
<li><a href="#localpath">Creating a function from local source</a></li>
<li>
<a href="#invoker">How the Node Function Invoker Works</a><ul>
<li><a href="#async">Async</a></li>
<li><a href="#streams">Streams (Experimental)</a></li>
<li><a href="#messages-payloads">Messages Versus Payloads</a></li>
<li><a href="#lifecycle">Lifecycle</a></li>
</ul>
</li>
</ul></div>
          </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <p><strong>Page last updated: <span data-behavior="DisplayModifiedDate" data-modified-date="1549363396000"></span></strong></p>

<p>This topic provides an overview of how to write JavaScript functions for Pivotal Function Service (PFS).
For more in-depth coverage see the riff <a href="https://github.com/projectriff/node-function-invoker/blob/master/README.md">node-function-invoker</a> on GitHub.</p>

<h2><a id="requirements"></a>Requirements</h2>

<ul>
<li>PFS has been <a href="/pfs/install.html">installed</a> and you have prepared a namespace.</li>
<li>The <code>pfs</code> CLI has been <a href="/pfs/install-download.html">installed</a>.</li>
<li><p>You have set <code>REGISTRY</code> and <code>REGISTRY_USER</code> environment variables.</p>

<p>For GCR use <code>gcr.io</code> and your GCP Project ID.</p>
<pre class="highlight shell_session"><code>export REGISTRY=gcr.io
export REGISTRY_USER=$(gcloud config get-value core/project)
</code></pre>

<p>For the local registry used with <a href="/pfs/install-on-minikube.html">Minikube</a> or <a href="/pfs/install-on-docker.html">Docker Desktop</a>, use registry name <code>registry.pfs.svc.cluster.local:5000</code> and a dummy username.</p>
<pre class="highlight shell_session"><code>export REGISTRY=registry.pfs.svc.cluster.local:5000
export REGISTRY_USER=testuser
</code></pre>

<h2><a id="cli-java"></a>Using the pfs CLI to Create a JavaScript Function</h2></li>
</ul>

<p>This example uses the sample <code>hello.js</code> function from <a href="https://github.com/projectriff-samples/hello.js">GitHub</a>. It consists of a single JavaScript file named <code>hello.js</code> with the following code:</p>
<pre class="highlight plaintext"><code>module.exports = x =&gt; `hello ${x}`
</code></pre>

<p>Create a <code>hello</code> function by running the CLI command below:</p>
<pre class="highlight shell_session"><code>pfs function create hello \
--git-repo https://github.com/projectriff-samples/hello.js \
--artifact hello.js \
--image $REGISTRY/$REGISTRY_USER/hello \
--verbose
</code></pre>

<p>The CLI output should show that the node invoker was selected (excerpt below), based on the value of the <code>--artifact</code> flag above.</p>
<pre class="highlight plaintext"><code>-----&gt; Process types:
       web:      node /workspace/io.projectriff.riff/riff-invoker-node/server.js
       function: node /workspace/io.projectriff.riff/riff-invoker-node/server.js
</code></pre>

<p>You should now be able to invoke the function service with the <code>pfs service invoke</code> command:</p>
<pre class="highlight shell_session"><code>pfs service invoke hello --text -- -w '\n' -d 'PFS'
</code></pre>
<pre class="highlight plaintext"><code>curl 35.205.116.145/ -H 'Host: hello.default.example.com' -H 'Content-Type: text/plain' -w '\n' -d PFS
hello PFS
</code></pre>

<h2><a id="localpath"></a> Creating a function from local source</h2>

<div class="note note">This capability is currently only available when using Minikube or Docker Desktop with a local registry. It will be extended to work in other environments in a future release.</div>

<p>First you must prepare your environment for local builds by setting the <code>PFS_BUILDER_IMAGE</code> and <code>PFS_PACKS_RUN_IMAGE</code> environment variables. See Installing PFS <a href="/pfs/install-on-minikube.html#localpath">on Minikube</a> or <a href="/pfs/install-on-docker.html#localpath">on Docker Desktop</a> for detailed instructions.</p>

<div class="note">Setting these environment variables will affect both local and cluster builds. We suggest opening a new terminal window before changing to a different Kubernetes context.</div>

<p>Here we assume that you have created the <code>pfs-local-path-env</code> file in your download directory. Source the file with the environment settings using (if it is in a different location just change the path):</p>
<pre class="highlight plaintext"><code>source ~/Downloads/pfs-local-path-env
</code></pre>

<p>To build a function from a local directory, use <code>--local-path</code> instead of <code>--git-repo</code>.</p>

<p>E.g. if you are in a directory with a file called <code>hello.js</code> just like the one above:</p>
<pre class="highlight shell_session"><code>pfs function create hello \
--local-path . \
--artifact hello.js \
--image $REGISTRY/$REGISTRY_USER/hello \
--verbose
</code></pre>

<p>To update the function and deploy a new revision:</p>
<pre class="highlight shell_session"><code>pfs function update wordcount \
  --local-path .
</code></pre>

<h2><a id="invoker"></a>How the Node Function Invoker Works</h2>

<p>At runtime, the node function invoker will <code>require()</code> the target function module.
This module must export the function to invoke.</p>
<pre class="highlight javascript"><code><span class="c1">// square</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">;</span>
</code></pre>

<p>The first argument is the triggering message&rsquo;s payload and the returned value is the resulting message&rsquo;s payload.</p>

<h3><a id="async"></a>Async</h3>

<p>Asynchronous work can be completed by defining either an <code>async function</code> or by returning a <code>Promise</code>.</p>
<pre class="highlight javascript"><code><span class="c1">// async</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">;</span>

<span class="c1">// promise</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">);</span>
</code></pre>

<h3><a id="streams"></a>Streams (Experimental)</h3>

<p>Streaming functions can be created by setting the <code>$interactionModel</code> property on the function to <code>node-streams</code>.
The function is invoked with two arguments: an <code>input</code> <a href="https://nodejs.org/dist/latest-v8.x/docs/api/stream.html#stream_class_stream_readable">Readable Stream</a> and an <code>output</code> <a href="https://nodejs.org/dist/latest-v8.x/docs/api/stream.html#stream_class_stream_writable">Writeable Stream</a>.
Both streams are object streams. Any value returned by the function is ignored, and new messages must be written to the output stream.</p>
<pre class="highlight javascript"><code><span class="c1">// echo.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$interactionModel</span> <span class="o">=</span> <span class="s2">"node-streams"</span><span class="p">;</span>
</code></pre>

<p>Any npm package that works with Node Streams can be used.</p>
<pre class="highlight javascript"><code><span class="c1">// upperCase.js</span>
<span class="kr">const</span> <span class="nx">miss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mississippi"</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">upperCaser</span> <span class="o">=</span> <span class="nx">miss</span><span class="p">.</span><span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">((</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">());</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">upperCaser</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$interactionModel</span> <span class="o">=</span> <span class="s2">"node-streams"</span><span class="p">;</span>
</code></pre>

<p>The <code>Content-Type</code> for output messages can be set with the <code>$defaultContentType</code> property. By default, <code>text/plain</code> is used. For request-reply function, the <code>Accept</code> header is used, but there is no <code>Accept</code> header in a stream.</p>
<pre class="highlight javascript"><code><span class="c1">// greeter.js</span>
<span class="kr">const</span> <span class="nx">miss</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mississippi"</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">greeter</span> <span class="o">=</span> <span class="nx">miss</span><span class="p">.</span><span class="nx">through</span><span class="p">.</span><span class="nx">obj</span><span class="p">((</span><span class="nx">chunk</span><span class="p">,</span> <span class="nx">enc</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">cb</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">greeting</span><span class="p">:</span> <span class="err">`</span><span class="nx">Hello</span> <span class="nx">$</span><span class="p">{</span><span class="nx">chunk</span><span class="p">}</span><span class="o">!</span><span class="err">`</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">input</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">greeter</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$interactionModel</span> <span class="o">=</span> <span class="s2">"node-streams"</span><span class="p">;</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$defaultContentType</span> <span class="o">=</span> <span class="s2">"application/json"</span><span class="p">;</span>
</code></pre>

<h3><a id="messages-payloads"></a>Messages Versus Payloads</h3>

<p>By default, functions accept and produce payloads. Functions that need to interact with headers can instead opt to receive and/or produce messages. A message is an object that contains both headers and a payload. Message headers are a map with case-insensitive keys and multiple string values.</p>

<p>Since JavaScript and Node have no built-in type for messages or headers, PFS uses the <a href="https://github.com/projectriff/node-message/">@projectriff/message</a> npm module. To use messages, functions install the <code>@projectriff/message</code> package:</p>
<pre class="highlight shell_session"><code>npm install --save @projectriff/message
</code></pre>

<h4><a id="receive"></a>Receiving Messages</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">Message</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'@projectriff/message'</span><span class="p">);</span>

<span class="c1">// a function that accepts a message, which is an instance of Message</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">authorization</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="c1">// tell the invoker the function wants to receive messages</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$argumentType</span> <span class="o">=</span> <span class="s1">'message'</span><span class="p">;</span>

<span class="c1">// tell the invoker to produce this particular type of message</span>
<span class="nx">Message</span><span class="p">.</span><span class="nx">install</span><span class="p">();</span>
</code></pre>

<h4><a id="produce"></a>Producing Messages</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">Message</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"@projectriff/message"</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">instanceId</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">invocationCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// a function that produces a Message</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s2">"X-PFS-Instance"</span><span class="p">,</span> <span class="nx">instanceId</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s2">"X-PFS-Count"</span><span class="p">,</span> <span class="nx">invocationCount</span><span class="o">++</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">payload</span><span class="p">(</span><span class="err">`</span><span class="nx">Hello</span> <span class="nx">$</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">!</span><span class="err">`</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">// even if the function receives payloads, it can still produce a message</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$argumentType</span> <span class="o">=</span> <span class="s2">"payload"</span><span class="p">;</span>
</code></pre>

<h3><a id="lifecycle"></a>Lifecycle</h3>

<p>Functions that communicate with external services, like a database, can use the <code>$init</code> and <code>$destroy</code> lifecycle hooks on the function.
These methods are invoked once per function invoker instance, whereas the target function may be invoked multiple times within a single function invoker instance.</p>

<p>The <code>$init</code> method is guaranteed to finish before the main function is invoked.
The <code>$destroy</code> method is guaranteed to be invoked after all of the main functions are finished.</p>
<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">client</span><span class="p">;</span>

<span class="c1">// function</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">({</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">amount</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">incrby</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">amount</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// setup</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$init</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">Redis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"redis-promise"</span><span class="p">);</span>
  <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Redis</span><span class="p">();</span>
  <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">// cleanup</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">$destroy</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span>
<span class="p">};</span>
</code></pre>

<p>The lifecycle methods are optional and should only be implemented when needed.
The hooks may be either traditional or async functions.
Lifecycle functions have up to 10 seconds to complete their work or the function invoker aborts.</p>

        <div align="center"><hr><p></p></div>
<div></div>
      </main>
    </div>
  </div>
</div>

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
  Questions or feedback? <a href="mailto:pfs-support@pivotal.io">Email pfs-support@pivotal.io</a>
  <br/>
  <br/>
  <a href='https://pivotal.io/privacy-policy'  target="_blank">Privacy Policy</a> | 
  <a href='https://pivotal.io/terms-of-use'  target="_blank">Terms of Use</a>
  <div id="teconsent"></div>

  <br/>
  <a href='/'>Pivotal Documentation</a>
  &copy; 2019 <a href='https://pivotal.io' target="_blank">Pivotal Software</a>, Inc. All Rights Reserved.
  <br/>
  <br/>
</div>


  </footer>
</div><!--end of container-->

</body>
</html>
